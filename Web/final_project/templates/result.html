{% extends 'layout.html' %}
{% block content %}
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.ajax-cross-origin.min.js') }}"></script>
<div class="header"><img class="icon_result" src="{{ url_for('static', filename='logo_new_white.png') }}" /></div>
<div class="wrap">
    <h2 style="text-align:left; margin: 10px"><font size="5px"> {{ data_list }} </font></h2>
    <div class="chat_table_div">
        <table class="chat_table">
            <thead>
                <tr>
                    <th class="chat_th 1">
                        기존 채팅
                    </th>
                    <th class="chat_th 1">
                        필터링
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="chat_td">
                        <div class="chat_div 1"></div>
                    </td>
                    <td class="chat_td">
                        <div class="chat_div 2"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <table class="wordcloud_table">
        <thead>
            <tr>
                <th class="chat_th 2">
                    워드클라우드
                </th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="chat_td">
                    <img crossOrigin="anonymous" src="/static/wordcloud.png" class="word_cloud" onerror="this.src='/static/wordcloud.png'" />
                </td>
            </tr>
            <tr>
                <td valign="top">
                    <table class="small_table 1" style="float:left">
                        <tr>
                            <th>감지된 욕설</th>
                        </tr>
                        <tr>
                            <td class="small_td" align="center">
                                <div class="abuse_div">&nbsp</div>
                            </td>
                        </tr>
                    </table>
                    <table class="small_table 2" style="float:left">
                        <tr>
                            <th>긍/부정지수</th>
                        </tr>
                        <tr>
                            <td class="small_td" align="center">
                                <div class="emotion_div">&nbsp</div>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>
    <figure>
        <div class="container-fluid">
            <div class="row">
                <div class="container-fluid" id="data-container"></div>
            </div>
        </div>
    </figure>
</div>

<div class="float_btn">
<a href='/' class='btn-floating'><img class="icon home" src="{{ url_for('static', filename='home_icon.png') }}" title="돌아가기" /></a><br>
<a href='/' class='btn-floating'><img class="icon contact" src="{{ url_for('static', filename='contact_icon.png') }}" title="문의하기" /></a>
</div>
<script type="text/javascript" src="{{ url_for('static', filename='js/highcharts.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/highcharts-more.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/series-label.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/exporting.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/export-data.js') }}"></script>
<script>
    var abuse_num = 0;
    var emotion_num = 0;
    var replicaCheckArray = [];
    var chart;
    setInterval(function(){$.ajax({
        crossOrigin: true,
        url: '/update',
        type: 'POST',
        success: function(response) {
            if (jQuery.inArray(response['msg']['chat_id'], replicaCheckArray) == -1) {
                replicaCheckArray.push(response['msg']['chat_id']);
                $( ".chat_div.1" ).append( "<p><b>"+response['msg']['user_name']+"</b>&nbsp&nbsp&nbsp"+response['msg']['chat_text']+"</p>" );
                const abuse_result = $.trim(response['msg']['abuse']);
                if ( abuse_result > 0.4 ) {
                    $( ".chat_div.2" ).append( "<p><b>"+response['msg']['user_name']+"</b>&nbsp&nbsp&nbsp<i><font color='gray'>욕설이 감지된 문장입니다</font></i></p>" );
                    abuse_num++;
                } else {
                    $( ".chat_div.2" ).append( "<p><b>"+response['msg']['user_name']+"</b>&nbsp&nbsp&nbsp"+response['msg']['chat_text']+"</p>" );
                }
                const $messageTextBox = $('.chat_div');
                $messageTextBox.scrollTop($messageTextBox[0].scrollHeight);
                $( ".abuse_div" ).text( abuse_num );

                const emotion_result = $.trim(response['msg']['emotion']);
                if ( emotion_result > 0.4 ) {
                    emotion_num++;
                } else {
                    emotion_num--;
                }
                $( ".emotion_div" ).text( emotion_num );

                if ( emotion_num < 0 ) {
                    $( ".small_table.2" ).css( "background-color", "#FFA7A7" );
                } else if ( emotion_num > 0 ) {
                    $( ".small_table.2" ).css( "background-color", "#B2CCFF" );
                } else {
                    $( ".small_table.2" ).css( "background-color", "#F6F6F6" );
                }

                $( ".word_cloud" ).attr( "src", "/static/img/" + response['image_name'] );

                var series = chart.series[0],
                    shift = series.data.length > 20;

                chart.series[0].addPoint([response['time_data'], emotion_num], true, shift);
            }
        },
        error: function(error) {
            console.log(error);
        }
    })}, 1000);

$(document).ready(function() {
    chart = new Highcharts.Chart({
        chart: {
            renderTo: 'data-container',
            defaultSeriesType: 'spline',
            events: {
                load: function() {
                    chart = this;
                    setInterval;
                }
            }
        },
        title: {
            text: '채팅창 분위기'
        },
        xAxis: {
            type: 'datetime',
            tickPixelInterval: 150,
            maxZoom: 20 * 1000
        },
        yAxis: {
            minPadding: 0.2,
            maxPadding: 0.2,
            title: {
                text: '긍부정 수치',
                margin: 80
            }
        },
        time: {
            useUTC: false
        },
        series: [{
            name: '긍부정지수',
            color: '#8C8C8C',
            data: [],
            zones: [{
                value: 0,
                color: '#FF007F'
            }, {
                color: '#0054FF'
            }]
        }]
    });
});

</script>
{% endblock %}