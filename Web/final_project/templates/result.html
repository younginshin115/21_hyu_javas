{% extends 'index.html' %}

{% block content %}
<h1>{{ data_list }}</h1>
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.ajax-cross-origin.min.js') }}"></script>
<div class="wrap">
    <div class="chat_table_div">
        <table class="chat_table">
            <thead>
                <tr>
                    <th class="chat_th 1">
                        기존 채팅
                    </th>
                    <th class="chat_th 1">
                        필터링
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="chat_td">
                        <div class="chat_div 1"></div>
                    </td>
                    <td class="chat_td">
                        <div class="chat_div 2"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <table class="wordcloud_table">
        <thead>
            <tr>
                <th class="chat_th 2">
                    워드클라우드
                </th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="chat_td">
                    <img crossorigin="Anonymous" src="/static/wordcloud.png" class="word_cloud" onerror="this.src='/static/wordcloud.png'" />
                </td>
            </tr>
            <tr>
                <td valign="top">
                    <table class="small_table 1" style="float:left">
                        <tr>
                            <th>감지된 욕설</th>
                        </tr>
                        <tr>
                            <td class="small_td" align="center">
                                <div class="abuse_div">&nbsp</div>
                            </td>
                        </tr>
                    </table>
                    <table class="small_table 2" style="float:left">
                        <tr>
                            <th>긍/부정지수</th>
                        </tr>
                        <tr>
                            <td class="small_td" align="center">
                                <div class="emotion_div">&nbsp</div>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<script>
    var abuse_num = 0;
    var emotion_num = 0;
    setInterval(function(){$.ajax({
        crossOrigin: true,
        url: '/update',
        type: 'POST',
        success: function(response) {
            $( ".chat_div.1" ).append( "<p>"+response['msg']['user_name']+" : "+response['msg']['chat_text']+"</p>" );
            const abuse_result = $.trim(response['msg']['abuse']);
            if ( abuse_result > 0.4 ) {
                $( ".chat_div.2" ).append( "<p>"+response['msg']['user_name']+" : <i><font color='gray'>욕설이 감지된 문장입니다</font></i></p>" );
                abuse_num++;
            } else {
                $( ".chat_div.2" ).append( "<p>"+response['msg']['user_name']+" : "+response['msg']['chat_text']+"</p>" );
            }
            const $messageTextBox = $('.chat_div');
            $messageTextBox.scrollTop($messageTextBox[0].scrollHeight);
            $( ".abuse_div" ).text( abuse_num );

            const emotion_result = $.trim(response['msg']['emotion']);
            if ( emotion_result > 0.4 ) {
                emotion_num++;
            } else {
                emotion_num--;
            }
            $( ".emotion_div" ).text( emotion_num );

            if ( emotion_num < 0 ) {
                $( ".small_table.2" ).css( "background-color", "#FFA7A7" );
            } else if ( emotion_num > 0 ) {
                $( ".small_table.2" ).css( "background-color", "#B2CCFF" );
            } else {
                $( ".small_table.2" ).css( "background-color", "#F6F6F6" );
            }

            $( ".word_cloud" ).attr( "src", "/static/img/" + response['image_name'] + '?' + new Date().getTime() );

        },
        error: function(error) {
            console.log(error);
        }
    })}, 1000);

</script>
{% endblock %}